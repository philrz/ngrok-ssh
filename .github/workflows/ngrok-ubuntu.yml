name: "ngrok SSH tunnel (Ubuntu)"

on:
  workflow_dispatch:
    inputs:
      run-on:
        description: 'Ubuntu runner image to use'
        required: true
        default: 'ubuntu-24.04'
        type: choice
        options:
        - ubuntu-24.04
        - ubuntu-22.04
        - ubuntu-slim

jobs:
  ngrok_ssh_tunnel:
    runs-on: ${{ github.event.inputs.run-on }}
    steps:
      - uses: actions/checkout@v3

      # Install SSH and disable socket activation (works for both 22.04 and 24.04)
      - name: Install and configure SSH server
        run: |
          sudo apt-get update
          sudo apt-get install -y openssh-server

          # Configure SSH for better performance
          echo "UseDNS no" | sudo tee -a /etc/ssh/sshd_config
          echo "GSSAPIAuthentication no" | sudo tee -a /etc/ssh/sshd_config

          # CRITICAL FIX: Disable socket activation
          # This fix works for BOTH Ubuntu 22.04 (if it has OpenSSH 9.x) AND Ubuntu 24.04
          # Socket activation doesn't work with ngrok TCP tunnels
          sudo systemctl disable --now ssh.socket 2>/dev/null || true
          sudo systemctl enable --now ssh.service

          # Verify SSH is running and listening on port 22
          echo "=== SSH Status ==="
          sudo systemctl status ssh.service --no-pager
          echo ""
          echo "=== Listening on port 22 ==="
          sudo ss -tlnp | grep :22
        shell: bash

      - name: Start SSH via ngrok
        run: ./start_ngrok_tunnel.sh
        env:
          NGROK_TOKEN: ${{ secrets.NGROK_TOKEN }}
          SSH_PUBLIC_KEY: ${{ secrets.NGROK_SSH_PUBLIC_KEY }}
        shell: bash

      - name: Keep tunnel alive for 24 hours
        run: sleep 86400
        shell: bash
